---
title: "Task 4 - Halloween Candy Data - Analysis questions"
output: html_notebook
---


```{r}
library(tidyverse)
library(here)
library(openxlsx)
candy <- read.xlsx(here("clean_data/clean_candy.xlsx"))
```

What is the total number of candy ratings given across the three years. (Number of candy ratings, not the number of raters. Donâ€™t count missing values)

```{r}
# this selects all candy columns, mutates them into a logical TRUE or FALSE depending on if they are NA or if they have values
# from there, sums all the values that are TRUE
# after, it sums those values into a new column - giving us the total amount of ratings
# The total ratings is 386924 out of 1159276 possible (9349*124) - Around 33%

candy %>% 
  select(!c(year, age, gender, country, going_trick_or_treating)) %>% 
  mutate(across(.col = is.character, .fns = is.na)) %>% 
  summarise(across(.col = where(is.logical), .fns = sum)) %>%
  mutate(total_ratings = sum(across(where(is.integer)))) %>% 
  select(total_ratings)
```

What was the average age of people who are going out trick or treating?

```{r}
candy %>% 
  select(age, going_trick_or_treating) %>% 
  drop_na() %>% 
  filter(going_trick_or_treating == "Yes") %>% 
  mutate(avg_age_t_t = mean(age)) %>% 
  select(avg_age_t_t) %>% 
  head(1)
```


What was the average age of people who are not going trick or treating?

```{r}
candy %>% 
  select(age, going_trick_or_treating) %>% 
  drop_na() %>% 
  filter(going_trick_or_treating == "No") %>% 
  mutate(avg_age_no_t_t = mean(age)) %>% 
  select(avg_age_no_t_t) %>% 
  head(1)
```


For each of joy, despair and meh, which candy bar received the most of these ratings?

```{r}
#making a subset of data containing only candy columns and replacing any NA's with characters "No Answer" 
# Incase there is any need to sum

only_candy <- candy %>% 
  select(-c(year, age, gender, country, going_trick_or_treating)) 

only_candy <- replace(only_candy,is.na(only_candy), "No Answer")

# This turns the candy columns and ratings into rows

tidyr::pivot_longer(only_candy, cols = everything(), names_to = "names", values_to = "rating") %>% 
  group_by(names, rating) %>% 
  arrange(names) %>% 
  count(rating) %>% 
  filter(rating != "No Answer") %>% 
  arrange(desc(n)) %>% 
  ungroup(names) %>% 
  slice(1)

# Some might argue that a broken glow stick is not candy - To satisfy any nitpickers, here is the answer if they are excluded
tidyr::pivot_longer(only_candy, cols = everything(), names_to = "names", values_to = "rating") %>% 
  group_by(names, rating) %>% 
  arrange(names) %>% 
  count(rating) %>% 
  filter(rating != "No Answer", names != "broken_glow_stick") %>% 
  arrange(desc(n)) %>% 
  ungroup(names) %>% 
  slice(1)


```

How many people rated Starburst as despair?

```{r}
# Using only_candy
only_candy %>% 
  select(starburst) %>% 
  mutate(starburst_despair = sum(starburst == "DESPAIR")) %>% 
  select(starburst_despair) %>% 
  head(1)
```


For the next three questions, count despair as -1, joy as +1, and meh as 0.
```{r}
# Separating code into two blocks - personal and candy data
# converting candy responses into numeric values then reattaching to personal data
# This creates a new data set to avoid future faffing about

only_personal <- candy %>% 
  select(year, age, gender, country, going_trick_or_treating)

candy_numeric <- only_candy %>%
  mutate(across(everything(), ~  case_when(
    . == "JOY" ~ 1,
    . == "DESPAIR" ~ -1,
    . == "MEH" ~ 0,
    . == "No Answer" ~ 0,
    TRUE ~ 0))) 

full_candy_numeric <- bind_cols(only_personal, candy_numeric)

```

What was the most popular candy bar by this rating system for each gender in the dataset ?

```{r}
full_candy_numeric %>%
  select(!c(year, age, country, going_trick_or_treating)) %>% 
  tidyr::pivot_longer(where(is.double), names_to = "candy_name", values_to = "rating") %>% 
  group_by(gender, candy_name) %>% 
  summarise(across(is.double, sum)) %>% 
  slice_max(rating)

  
```

What was the most popular candy bar in each year?


```{r}
full_candy_numeric %>%
  select(!c(age, gender, country, going_trick_or_treating)) %>% 
  tidyr::pivot_longer(cols = -year, names_to = "candy_name", values_to = "rating") %>% 
  group_by(year, candy_name) %>% 
  summarise(across(is.double, sum)) %>% 
  slice_max(rating)

```

What was the most popular candy bar by this rating for people in US, Canada, UK, and all other countries?

```{r}
full_candy_numeric %>%
  select(!c(year, age, gender, going_trick_or_treating)) %>% 
  tidyr::pivot_longer(where(is.double), names_to = "candy_name", values_to = "rating") %>% 
  group_by(country, candy_name) %>% 
  summarise(across(is.double, sum)) %>% 
  slice_max(rating)
```

